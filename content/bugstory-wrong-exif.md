Title: Вот это поворот...
Date: 2015-09-06 15:00
Modified: 2015-09-06 15:00
Category: Bugstory
Tags: python, exif, bug, magic, crop, jpg, thumbnail, pil, image, lena
Image: /media/md-headers/pelican-md.png
Summary:
    Однажды столкнулся с магическим багом, причину возникновения которого,
    неудавалось отыскать на протяжении трёх недель. Да что там причину,
    его даже воспроизвести никак не удавалось. Заказчик постоянно жаловался
    что изображения обрезаются неправильно, да при том ещё непредсказуемо
    поворачиваются...

Однажды столкнулся с магическим багом, причину возникновения которого,
неудавалось отыскать на протяжении трёх недель. Да что там причину,
его даже воспроизвести никак не удавалось. Заказчик постоянно жаловался
что изображения обрезаются неправильно, да при том ещё непредсказуемо
поворачиваются...

##Неуловимая ошибка

Суть проекта заключалась в том, что пользователи выкладывают фотографии,
сопровождая их коротенькими историями, далее модераторы проверяют контент
на соответствие тематике ресурса, обрезают фотографии по необходимому
соотношению сторон и публикуют эти истории.

Буквально с первых же дней выхода проекта в продакшн, начали поступать жалобы
от модераторов. Жаловались на то, что фотографии обрезаются не так как это
ожидается, иногда появляются черные полоски, иногда фотографии внезапно
поворачиваются, иногда вообще не происходит каких либо изменений после обрезки.

Для обрезки изображений использовалась библиотека
[django-image-cropping](https://pypi.python.org/pypi/django-image-cropping),
которая позволяет в админке джанго обрезать изображения при помощи `jQuery`
плагина [Jcrop](http://deepliquid.com/content/Jcrop.html).

##Ложные обвинения

Поскольку ошибку никак не удавалось воспроизвести, стали полагать, что причина
прячется где то в клиентской части. За две с половиной недели поиска ошибки,
были перепробованы чуть менее чем все комбинации различных браузеров и
операционных систем, включая устаревшие версии браузеров. Но воспроизвести
ошибку все никак не удавалось.

Тем неменее, усердное тестирование обрезки изображения в различных браузерах
выявило сопутствующую ошибку. От браузера, кстати, независящую. Продакшен
сервер был оптимизирован под большое количество посетителей. Сам проект
представлял из себя регенерируемый, статический сайт, кешированный `nginx`ом;
небольшое `api` для добавления и поиска историй; и административный интерфейс
для премодерации историй и перегенерации статического контента.

Так получилось, что `nginx` слишком усердно справлялся с кешированием,
и достаточно часто после обрезки изображения в админке показывал "старое"
(не обрезанное изображение), после чего модератор снова и снова "обрезал"
картинку, а в результате исходное изображение резалось по несуществующим
координатам. Соответственно на выходе получалось изкромсаное изображение с
черными полосками и когда кеш обновлялся то это становилось заметно.

Данную ошибку с кеширование легко исправить введя случайный `GET` параметр в
адресе изображения перед выводом его в админке.
Примерно так:

```python
from random import randint
rand_url = lambda url: '{url}?{num}'.format(url=url, num=randint(10000, 99999))

# ...

return {
    # ...
    'data-thumbnail-url': rand_url(thumbnail(image).url)
    # ...
}
```

Вследствии чего, проблема отображения "старого" изображения после обрезки
исчезла. В админке выводился следующий `html` код отображения изображения:

```html
```

Казалось что ошибка найдена и ликвидирована. Можно торжествовать победу.

##