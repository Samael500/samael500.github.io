<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#00aeff"><meta name="msapplication-navbutton-color" content="#00aeff"><meta name="apple-mobile-web-app-status-bar-style" content="#00aeff"><meta name="author" content="Maks"><meta name="robots" content="index, follow"><meta name="keywords" content="article, letsencrypt, nginx, ssl, https, secure, git"><meta property="og:title" content="Давайте шифровать!"><meta property="og:url" content="https://maks.live/articles/secure/davaite-shifrovat/"><meta property="og:site_name" content="Maks live"><meta property="og:type" content="article"><meta property="og:image" content="https://maks.live/media/letsencrypt/letsencrypt.jpg"><meta property="og:description" content="Let's Encrypt представляет собой центр сертификации, который позволяет просто и бесплатно получить TLS / SSL сертификаты, тем самым позволяя использовать зашифрованное соединение HTTPS. В данный момент сервис находится на этапе бета тестирования, и получить сертификат в полностью автоматическом режиме, можно лишь при использовании веб-сервера Apache. Я предпочитаю использовать nginx, поэтому опишу как легко получить сертификат в ручном режиме."><link rel="canonical" href="https://maks.live/articles/secure/davaite-shifrovat/"><title>Давайте шифровать! | Maks live</title><link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css"><link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.css"><link rel="stylesheet" type="text/css" href="/theme/css/style.css"><link rel="stylesheet" type="text/css" href="/theme/css/pygment.css"><link rel="stylesheet" type="text/css" href="/theme/css/social-likes_flat.css"><script type="text/javascript" src="/theme/js/jquery.min.js"></script><script type="text/javascript" src="/theme/js/bootstrap.min.js"></script><script type="text/javascript" src="/theme/js/social-likes.min.js"></script><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/tree.css"><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/anchorific.css"><script type="text/javascript" src="https://maks.live/theme/js/anchorific.js"></script></head><body id="index"><a class="forkmegithub" href="https://github.com/Samael500"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a><div class="header"><div class="container"><div class="logo"><a href="https://maks.live/"> MAKS LIVE </a></div><div class="top-menu"><div class="search"><script>
  (function() {
    var cx = '006263355362628034990:cuxoisonrno';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script><form id="searchbox_006263355362628034990:cuxoisonrno" action="https://www.google.com/"><input value="006263355362628034990:cuxoisonrno" name="cx" type="hidden"><input value="FORID:11" name="cof" type="hidden"><input id="q" name="q" type="text" required><input type="submit" value></form></div><span class="menu"></span><ul><li><a href="/">HOME</a></li><li><a href="/tag/best/">BEST</a></li><li><a href="https://maks.live/about/">ABOUT</a></li><div class="clearfix"></div></ul></div><div class="clearfix"></div><script>
                $("span.menu").click(function(){
                    $(".top-menu ul").slideToggle("slow" , function(){
                    });
                });
            </script></div></div></div><div class="content"><div class="container"><div class="content-grids"><div class="single-main"><div class="col-md-9 single-grid"><header><h4><a href="https://maks.live/articles/secure/davaite-shifrovat/" title="Давайте шифровать!">Давайте&nbsp;шифровать!</a> Jan 15, 2016 </h4><div class="footer art-info"> Author: <a class="url fn" href="https://maks.live/author/maks/">Maks</a> | Category: <a href="https://maks.live/category/secure.html">Secure</a> | <a href="https://maks.live/articles/secure/davaite-shifrovat/#disqus_thread">Comments</a><br> Tags: <a href="https://maks.live/tag/letsencrypt/">letsencrypt</a><a href="https://maks.live/tag/nginx/">nginx</a><a href="https://maks.live/tag/ssl/">ssl</a><a href="https://maks.live/tag/https/">https</a><a href="https://maks.live/tag/secure/">secure</a><a href="https://maks.live/tag/git/">git</a></div><div class="social-likes"><div class="vkontakte" title="Поделиться ссылкой во Вконтакте">Вконтакте</div><div class="twitter" data-via="samael500" title="Поделиться ссылкой в Твиттере">Twitter</div><div class="facebook" title="Поделиться ссылкой на Фейсбуке">Facebook</div><div class="plusone" title="Поделиться ссылкой в Google+">Google+</div></div></header><article class="content"><p><code>Let's Encrypt</code> представляет собой центр сертификации, который позволяет просто и <strong>бесплатно</strong> получить <code>TLS / SSL</code> сертификаты, тем самым позволяя использовать зашифрованное соединение <code>HTTPS</code>. В данный момент сервис находится на этапе бета тестирования, и получить сертификат в полностью автоматическом режиме, можно лишь при использовании веб-сервера <code>Apache</code>. Я предпочитаю использовать <code>nginx</code>, поэтому опишу как легко получить сертификат в ручном&nbsp;режиме.</p><h2 id="poluchenie-sertifikata-lets-encrypt"><a class="toclink" href="#poluchenie-sertifikata-lets-encrypt">Получение сертификата Let&#8217;s&nbsp;Encrypt</a></h2><p><code>Let's Encrypt</code> устанавливается просто клонируя&nbsp;репозиторий.</p><div class="highlight"><pre><span></span>$ sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt
$ <span class="nb">cd</span> <span class="nb">cd</span> /opt/letsencrypt
</pre></div><p>Теперь получим сертификат используя следующую&nbsp;команду:</p><div class="highlight"><pre><span></span>$ ./letsencrypt-auto certonly --standalone
</pre></div><p>Для данной команды необходимы привелегии суперпользователя, так что возможно будет потребован ввод&nbsp;пароля.</p><p>Поскольку для проверки домена производитсья запрос на 80 порт, то он должен быть&nbsp;свободен.</p><p><img alt="nginx error" class="center" src="/media/letsencrypt/nginx.png"></p><p>Что бы освободить порт, можно временно остановить <code>nginx</code> выполнив&nbsp;команду:</p><div class="highlight"><pre><span></span>$ sudo service nginx stop
</pre></div><p><code>letsencrypt</code> запрашивает адрес электронной почты для уведомлений или востановления&nbsp;ключей.</p><p><img alt="email" class="center" src="/media/letsencrypt/email.png"></p><p>Далее, предлагают согласиться с условиями использования&nbsp;сервиса.</p><p><img alt="agree" class="center" src="/media/letsencrypt/agree.png"></p><p>После, нужно указать для какого домена создается сертифика. Включая все необходимые&nbsp;поддомены.</p><p><img alt="domain" class="center" src="/media/letsencrypt/domain.png"></p><p>При успешном получении сертификата, выдается следующее&nbsp;сообщение:</p><div class="highlight"><pre><span></span>IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/you.domain.com/fullchain.pem. Your cert
   will expire on 2016-15-06. To obtain a new version of the
   certificate in the future, simply run Let&#39;s Encrypt again.
 - If you like Let&#39;s Encrypt, please consider supporting our work by:

   Donating to ISRG / Let&#39;s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</pre></div><p>После успешного получения сертификата у вас будут следующие&nbsp;файлы:</p><ul><li>cert.pem: Сертификат&nbsp;домена</li><li>chain.pem: Let&#8217;s Encrypt&nbsp;сертификат</li><li>fullchain.pem: cert.pem и chain.pem&nbsp;объединенные</li><li>privkey.pem: Ключ&nbsp;сертификата</li></ul><p>Что бы проверить что сертификаты успешно созданы и доступны, выведите содержимое директории <code>/etc/letsencrypt/live/your_domain_name</code>, где <code>your_domain_name</code> имя вашего&nbsp;домена.</p><div class="highlight"><pre><span></span>$ sudo ls /etc/letsencrypt/live/your_domain_name
</pre></div><h2 id="podkliuchenie-sertifikata-v-nginx"><a class="toclink" href="#podkliuchenie-sertifikata-v-nginx">Подключение сертификата в&nbsp;nginx</a></h2><p>Что бы правильно настроить <code>ssl</code> есть такая замечательная <a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">шпаргалка</a> от <code>mozilla</code>.</p><p>В общем случае достаточно использовать следующие&nbsp;настройки:</p><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>

    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">example.com</span> <span class="s">www.example.com</span><span class="p">;</span>

    <span class="c1"># certs sent to the client in handshake are concatenated in ssl_certificate</span>
    <span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/example.com/fullchain.pem</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/example.com/privkey.pem</span><span class="p">;</span>
    <span class="kn">ssl_session_timeout</span> <span class="s">1d</span><span class="p">;</span>
    <span class="kn">ssl_session_cache</span> <span class="s">shared:SSL:50m</span><span class="p">;</span>
    <span class="kn">ssl_session_tickets</span> <span class="no">off</span><span class="p">;</span>

    <span class="c1"># secure configuration</span>
    <span class="kn">ssl_protocols</span> <span class="s">TLSv1</span> <span class="s">TLSv1.1</span> <span class="s">TLSv1.2</span><span class="p">;</span>
    <span class="kn">ssl_ciphers</span> <span class="s">&#39;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&#39;</span><span class="p">;</span>
    <span class="kn">ssl_prefer_server_ciphers</span> <span class="no">on</span><span class="p">;</span>

    <span class="c1"># ...</span>

<span class="p">}</span>
</pre></div><p>Для перманентного перенаправления на защизенное соединение, нужно создать дополнительный блок <code>server</code>.</p><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="p">}</span>
</pre></div><p>После внесения изменений в настройки сервера, нужно не забыть перезагрузить службу <code>nginx</code>.</p><div class="highlight"><pre><span></span>$ sudo service nginx restart
$ <span class="c1"># or</span>
$ sudo nginx -s reload
</pre></div><p>Готово. Теперь вы можете открыть ваш сайт используя защищенное&nbsp;соединение.</p><h2 id="avtomaticheskoe-obnovlenie-sertifikata"><a class="toclink" href="#avtomaticheskoe-obnovlenie-sertifikata">Автоматическое обновление&nbsp;сертификата</a></h2><p>Сертификаты, которые выдает <code>Let's Encrypt</code>, действительны всего 90 дней. В сравнениями с другими центрами сертификации, которые выдают сертификаты на год. Данный период кажется подозрительно коротким. Однако, в дальнейшем сроки сертификатов планируют ещё сократить. Это сделано с целью уменьшения угрозы от компрометации приватного ключа, а так же призывает повсеместно использовать автопродление сертификатов, в связи с тем, что через год, можно и забыть его&nbsp;продлить.</p><p>Автопродление сертификата проходит с помощью плагина <code>webroot</code>, который для верификации помещает специальный файл в директорию <code>./well-known</code> доступную для чтения&nbsp;вебсервером.</p><div class="highlight"><pre><span></span>    <span class="k">location</span> <span class="p">~</span> <span class="sr">/.well-known</span> <span class="p">{</span>
        <span class="kn">root</span> <span class="s">/path/to/root</span><span class="p">;</span>
        <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div><p>Теперь мы можем использовать <code>letsencrypt-auto</code> с дополнительным параметром <code>webroot-path</code>, передавая домены с помощью ключа <code>-d</code>:</p><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/letsencrypt
$ ./letsencrypt-auto certonly -a webroot --agree-tos --renew-by-default <span class="se">\</span>
    --webroot-path<span class="o">=</span>/path/to/root -d example.com -d www.example.com
</pre></div><p>В результате обновления сертификата вы получите следующее&nbsp;сообщение:</p><div class="highlight"><pre><span></span>IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/example.com/fullchain.pem. Your cert will
   expire on 2016-05-22. To obtain a new version of the certificate in
   the future, simply run Let&#39;s Encrypt again.
 - If you like Let&#39;s Encrypt, please consider supporting our work by:

   Donating to ISRG / Let&#39;s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</pre></div><p>Получив обновленный сертификат, для его использования нужно перезапустить <code>nginx</code></p><div class="highlight"><pre><span></span>$ sudo service nginx restart
$ <span class="c1"># or</span>
$ sudo nginx -s reload
</pre></div><p>Теперь создадим конфигурационный файл, для автоматической подстановки параметров. Шаблон конфигурационного файла находится в примерах <code>letsencrypt</code>.</p><div class="highlight"><pre><span></span>$ cat /opt/letsencrypt/examples/cli.ini
<span class="c1"># This is an example of the kind of things you can do in a configuration file.</span>
<span class="c1"># All flags used by the client can be configured here. Run Let&#39;s Encrypt with</span>
<span class="c1"># &quot;--help&quot; to learn more about the available options.</span>

<span class="c1"># Use a 4096 bit RSA key instead of 2048</span>
rsa-key-size <span class="o">=</span> <span class="m">4096</span>

<span class="c1"># Uncomment and update to register with the specified e-mail address</span>
<span class="c1"># email = foo@example.com</span>

<span class="c1"># Uncomment and update to generate certificates for the specified</span>
<span class="c1"># domains.</span>
<span class="c1"># domains = example.com, www.example.com</span>

<span class="c1"># Uncomment to use a text interface instead of ncurses</span>
<span class="c1"># text = True</span>

<span class="c1"># Uncomment to use the standalone authenticator on port 443</span>
<span class="c1"># authenticator = standalone</span>
<span class="c1"># standalone-supported-challenges = tls-sni-01</span>

<span class="c1"># Uncomment to use the webroot authenticator. Replace webroot-path with the</span>
<span class="c1"># path to the public_html / webroot folder being served by your web server.</span>
<span class="c1"># authenticator = webroot</span>
<span class="c1"># webroot-path = /usr/share/nginx/html</span>
</pre></div><p>Скопируем его в директорию <code>/usr/local/etc</code>:</p><div class="highlight"><pre><span></span>$ sudo cp /opt/letsencrypt/examples/cli.ini /usr/local/etc/le-renew-webroot.ini
</pre></div><p>Далее отредактируем его, изменив параметры <code>email</code>, <code>domains</code> и <code>webroot-path</code>.</p><div class="highlight"><pre><span></span>$ sudo nano /usr/local/etc/le-renew-webroot.ini

<span class="c1"># This is an example of the kind of things you can do in a configuration file.</span>
<span class="c1"># All flags used by the client can be configured here. Run Let&#39;s Encrypt with</span>
<span class="c1"># &quot;--help&quot; to learn more about the available options.</span>

<span class="c1"># Use a 4096 bit RSA key instead of 2048</span>
rsa-key-size <span class="o">=</span> <span class="m">4096</span>

<span class="c1"># Uncomment and update to register with the specified e-mail address</span>
<span class="nv">email</span> <span class="o">=</span> user@example.com

<span class="c1"># Uncomment and update to generate certificates for the specified</span>
<span class="c1"># domains.</span>
<span class="nv">domains</span> <span class="o">=</span> example.com, www.example.com

<span class="c1"># Uncomment to use a text interface instead of ncurses</span>
<span class="c1"># text = True</span>

<span class="c1"># Uncomment to use the standalone authenticator on port 443</span>
<span class="c1"># authenticator = standalone</span>
<span class="c1"># standalone-supported-challenges = tls-sni-01</span>

<span class="c1"># Uncomment to use the webroot authenticator. Replace webroot-path with the</span>
<span class="c1"># path to the public_html / webroot folder being served by your web server.</span>
<span class="c1"># authenticator = webroot</span>
webroot-path <span class="o">=</span> /path/to/root
</pre></div><p>Теперь, вместо того что бы указывать параметры с помощью ключей комманды <code>letsencrypt</code>, мы можем использовать конфигурационный&nbsp;файл:</p><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /opt/letsencrypt
$ ./letsencrypt-auto certonly -a webroot --renew-by-default <span class="se">\</span>
    --config /usr/local/etc/le-renew-webroot.ini
</pre></div><p>Скачаем и сделаем исполнимым скрипт автообновления&nbsp;сертификата.</p><div class="highlight"><pre><span></span>$ sudo curl -L -o /usr/local/sbin/le-renew-webroot <span class="se">\</span>
    https://gist.githubusercontent.com/thisismitch/e1b603165523df66d5cc/raw/fbffbf358e96110d5566f13677d9bd5f4f65794c/le-renew-webroot
$ sudo chmod +x /usr/local/sbin/le-renew-webroot
</pre></div><p>Теперь если его выполнить, то будет выдано ссобщение, о том, что сертификат не нуждается в&nbsp;обновлении.</p><div class="highlight"><pre><span></span>$ sudo le-renew-webroot
Checking expiration date <span class="k">for</span> example.com...
The certificate is up to date, no need <span class="k">for</span> renewal <span class="o">(</span><span class="m">89</span> days left<span class="o">)</span>.
</pre></div><p>Для того что бы скрипт регулярно проверял состояние сертификата добавим его запуск в таблицу&nbsp;крона:</p><div class="highlight"><pre><span></span>$ sudo crontab -e
</pre></div><p>Добавим строчку, которая будет запускать скрипт каждое воскресенье в 5.30 утра, и логировать результат в файл <code>/var/log/le-renewal.log</code>:</p><div class="highlight"><pre><span></span><span class="m">30</span> <span class="m">5</span> * * <span class="m">7</span> /usr/local/sbin/le-renew-webroot &gt;&gt; /var/log/le-renewal.log
</pre></div><p>Теперь можно не беспокоится о сроке годности сертификата, он будет регулярно обновлятся, когда будет приближаться срок истечения&nbsp;сертификата.</p></article><div class="comments"><div id="disqus_thread"></div><script type="text/javascript">
                    var disqus_identifier = "articles/secure/davaite-shifrovat/";
                    (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//samael500.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script></div></div><div class="col-md-3 content-right"><div class="anchorific"></div></div></div></div></div></div><div class="footer"><div class="container"><p>This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.</p><p><a href="http://github.com/samael500/w3-personal-blog/">W3 Personal Blog</a> is a flat <a href="http://getbootstrap.com/">bootstrap</a> responsive theme designed by <a href="https://w3layouts.com/personal-blog-a-blogging-category-flat-bootstrap-responsive-web-template/">W3layouts</a> ported to a pelican by <a href="http://samael500.github.io/">Samael500</a>.<p><p>Copyrights &copy; 2015&mdash;2017 Maks live All rights reserved.</p><p><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"> Creative Commons Attribution 4.0 International License</a>.</p></div></div><script type="text/javascript" src="https://www.l2.io/ip.js?var=userip"></script><script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter32194009 = new Ya.Metrika({
                    id:32194009,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true,
                    params:{'ip': userip}
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script><noscript><div><img src="https://mc.yandex.ru/watch/32194009" style="position:absolute; left:-9999px;" alt></div></noscript><script type="text/javascript">
    var disqus_shortname = 'samael500';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script></body></html>