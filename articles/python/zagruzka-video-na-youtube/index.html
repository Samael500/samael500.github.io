<!DOCTYPE html>
<html lang="ru"> <head><title>Загрузка видео на youtube | Maks live</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#00aeff"><meta name="msapplication-navbutton-color" content="#00aeff"><meta name="apple-mobile-web-app-status-bar-style" content="#00aeff"><meta name="author" content="Maks"><meta name="robots" content="index, follow"><meta name="keywords" content="article, python, youtube, oauth2, video upload"><meta name="description" content="В одном из моих собственных проектов, возникла задача автоматической загрузки видео на канал на youtube. Делается это достаточно просто, при помощи гугловского api клиента для python. Единственное затруднение вызвало полумагическое получение ключей доступа к api…"><meta property="og:title" content="Загрузка видео на youtube"><meta property="og:url" content="https://maks.live/articles/python/zagruzka-video-na-youtube/"><meta property="og:site_name" content="Maks live"><meta property="og:type" content="article"><meta property="og:image" content="https://maks.live/media/youtube-upload/python_youtube.jpg"><meta property="og:description" content="В одном из моих собственных проектов, возникла задача автоматической загрузки видео на канал на youtube. Делается это достаточно просто, при помощи гугловского api клиента для python. Единственное затруднение вызвало полумагическое получение ключей доступа к api…"><link rel="canonical" href="https://maks.live/articles/python/zagruzka-video-na-youtube/"><link href="https://maks.live/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Maks live Atom"><link href="https://maks.live/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Maks live RSS"><link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css"><link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.css"><link rel="stylesheet" type="text/css" href="/theme/css/style.css"><link rel="stylesheet" type="text/css" href="/theme/css/pygment.css"><link rel="stylesheet" type="text/css" href="/theme/css/social-likes_flat.css"><script type="text/javascript" src="/theme/js/jquery.min.js"></script><script type="text/javascript" src="/theme/js/bootstrap.min.js"></script><script type="text/javascript" src="/theme/js/social-likes.min.js"></script><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/tree.css"><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/anchorific.css"><script type="text/javascript" src="https://maks.live/theme/js/anchorific.js"></script></head> <body id="index"> <a class="forkmegithub" href="https://github.com/Samael500"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="/theme/images/forkme_right_gray.png" alt="Fork me on GitHub"> </a> <div class="header"> <div class="container"> <div class="logo"> <a href="https://maks.live/"> MAKS LIVE<br><small>samael500 blog</small> </a> </div> <div class="top-menu"> <div class="search"> <script>
  (function() {
    var cx = '006263355362628034990:cuxoisonrno';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script> <form id="searchbox_006263355362628034990:cuxoisonrno" action="https://www.google.com/"> <input value="006263355362628034990:cuxoisonrno" name="cx" type="hidden"> <input value="FORID:11" name="cof" type="hidden"> <input id="q" name="q" type="text" required> <input type="submit" value> </form> </div> <span class="menu"> </span> <ul> <li> <a href="/">HOME</a></li> <li> <a href="/tag/best/">BEST</a></li> <li><a href="https://maks.live/about/">ABOUT</a></li> <div class="clearfix"></div> </ul> <div class="clearfix"></div> <script>
                $("span.menu").click(function(){
                    $(".top-menu ul").slideToggle("slow" , function(){
                    });
                });
            </script> </div> </div> </div> <div class="content"> <div class="container"> <div class="content-grids"> <div class="single-main"> <div class="col-md-9 single-grid"> <header> <h4> <a href="https://maks.live/articles/python/zagruzka-video-na-youtube/" title="Загрузка видео на youtube">Загрузка видео на&nbsp;youtube</a> Aug 22, 2015 </h4> <div class="footer art-info"> Author: <a class="url fn" href="https://maks.live/author/maks/">Maks</a> | Category: <a href="https://maks.live/category/python/">Python</a> | <a href="https://maks.live/articles/python/zagruzka-video-na-youtube/#disqus_thread">Comments</a> <br> Tags: <a href="https://maks.live/tag/python/">python</a> <a href="https://maks.live/tag/youtube/">youtube</a> <a href="https://maks.live/tag/oauth2/">oauth2</a> <a href="https://maks.live/tag/video-upload/">video upload</a> </div><div class="social-likes"> <div class="vkontakte" title="Поделиться ссылкой во Вконтакте">Вконтакте</div> <div class="twitter" data-via="samael500" title="Поделиться ссылкой в Твиттере">Twitter</div> <div class="facebook" title="Поделиться ссылкой на Фейсбуке">Facebook</div> <div class="plusone" title="Поделиться ссылкой в Google+">Google+</div> </div> </header> <article class="content"> <p>В одном из моих собственных проектов, возникла задача автоматической загрузки видео на канал на <code>youtube</code>. Делается это достаточно просто, при помощи гугловского <code>api</code> клиента для <code>python</code>. Единственное затруднение вызвало полумагическое получение ключей доступа к <code>api</code>.</p> <h2 id="avtorizatsiia"><a class="toclink" href="#avtorizatsiia">Авторизация</a></h2> <blockquote> <p>Все коды доступа и ключи авторизации, использованные в статье, вымышленные.<br> Любое совпадение с реально существующими или когда-либо существовавшими ключами&nbsp;случайно.</p> </blockquote> <h4 id="sozdanie-novogo-proekta"><a class="toclink" href="#sozdanie-novogo-proekta">Создание нового&nbsp;проекта</a></h4> <p>Для авторизации в сервисах <code>google</code> с помощью протокола <a href="http://oauth.net/2/">oauth2</a> необходимо зарегистрировать приложение и дать ему соответсвующие права. Для этого нужно перейти в <a href="https://console.developers.google.com/project">консоль разработчика</a>.</p> <p>Нажимаем на кнопку <code>Create Project</code>, выбираем имя и создаем новое приложение. После того как приложение будет создано, нужно добавить ему необходимые доступы к google <span class="caps">API</span>.</p> <p><img alt="Create Project" class="shadow center" src="/media/youtube-upload/create_proj.png"></p> <p>Для загрузки видео на <code>youtube</code> нужно добавить <code>YouTube Data API</code>. Для этого переходим во вкладку <code>APIs &amp; auth</code> &rarr; <code>APIs</code>. Также во вкладке <code>APIs &amp; auth</code> &rarr; <code>Credentials</code> нужно добавить доступы для <code>oauth2</code> авторизации.</p> <p><img alt="Add Oauth2" class="shadow center" src="/media/youtube-upload/oauth_cred.png"></p> <p>Указываем тип приложения <code>Other</code>. Получаем доступы для авторизации: идентификатор и&nbsp;пароль.</p> <ul> <li>Client <span class="caps">ID</span> <code>230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com</code></li> <li>Client secret <code>qawsWCd3J6HTRvnqsjYUpgH9</code></li> </ul> <h4 id="prava-dostupa-k-akkauntu"><a class="toclink" href="#prava-dostupa-k-akkauntu">Права доступа к&nbsp;аккаунту</a></h4> <p>Получив данные для авторизации, нужно перейти по следующей ссылке, заменив в ней параметр <code>client_id</code> на тот, что Вы получили в предыдущем&nbsp;шаге.</p> <div class="highlight"><pre><span></span>    https://accounts.google.com/o/oauth2/auth?
        client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;
        redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;
        scope=https://www.googleapis.com/auth/youtube&amp;
        response_type=code&amp;
        access_type=offline
</pre></div> <p>Далее выбираем к какому аккаунту гугл будет иметь доступ приложение, и соответсвенно к какому каналу на&nbsp;ютубе.</p> <p><img alt="account choice" class="shadow center" src="/media/youtube-upload/account_choice.png"></p> <p><img alt="ch choice" class="shadow center" src="/media/youtube-upload/ch_choice.png"></p> <p>Соглашаемся с доступом к управлению&nbsp;каналом.</p> <p><img alt="access" class="shadow center" src="/media/youtube-upload/access.png"></p> <p>Получаем токен авторизации следующего вида <code>4/Rw6A9raJQ3PrPWL0Q9z49guYu89FZoz322RySVFtzNc</code>.</p> <p><img alt="code" class="shadow center" src="/media/youtube-upload/code.png"></p> <h4 id="obnovliaemyi-token"><a class="toclink" href="#obnovliaemyi-token">Обновляемый&nbsp;токен</a></h4> <p>После этого необходимо получить, так называемый, <code>refresh_token</code>, для этого нужно отправить <code>POST</code> запрос с токеном авторизации по адресу <code>https://accounts.google.com/o/oauth2/token</code>. Сделать это легко, при помощи консольной утилиты <a href="http://curl.haxx.se/">curl</a>.</p> <div class="highlight"><pre><span></span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="se">\</span>
<span class="s2">&quot;code=4/Rw6A9raJQ3PrPWL0Q9z49guYu89FZoz322RySVFtzNc&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_secret=qawsWCd3J6HTRvnqsjYUpgH9&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;grant_type=authorization_code&quot;</span>

curl --data <span class="nv">$data</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/token&quot;</span>
</pre></div> <p>Токен авторизации сработает только один раз, при повторной попытке отправить его будет получено <code>Code was already redeemed.</code>. В ответ на корректный запрос, гугл возвращает <code>json</code> с временным токеном доступа и постоянным обновляемым токеном (собственно он нам и&nbsp;нужен).</p> <div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;access_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;ya29.1wGYJU7NP7Ul69c13aE1Vuvbx0LfxrsgMiBjXdNY3sU3tuE9LmuJ3nOGHeb3e_824LH0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;token_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
    <span class="nt">&quot;expires_in&quot;</span> <span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;refresh_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;1/g1ixyts83iMrtR71oFqwGp3LSGbHz6ByxsBThrHRWCNIgOrJDtdun6zK6XiATCKT&quot;</span>
<span class="p">}</span>
</pre></div> <h4 id="token-dostupa"><a class="toclink" href="#token-dostupa">Токен&nbsp;доступа</a></h4> <p>Получив обновляемый токен, можем с его помощью каждый раз получать рабочий токен доступа, который предоставляется временем на 3600&nbsp;секунд.</p> <div class="highlight"><pre><span></span><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="se">\</span>
<span class="s2">&quot;refresh_token=1/g1ixyts83iMrtR71oFqwGp3LSGbHz6ByxsBThrHRWCNIgOrJDtdun6zK6XiATCKT&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_secret=qawsWCd3J6HTRvnqsjYUpgH9&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;grant_type=refresh_token&quot;</span>

curl --data <span class="nv">$data</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/token&quot;</span>
</pre></div> <p>В ответ гугл возвращает <code>json</code> с временным токеном&nbsp;доступа.</p> <div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;access_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;ya29.2AHpPjacO0prQkip0svapohuZtoK0wqdh7u0ohH49l0WWwrSyss7CWiwzMy5wX967tWsjQ&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
  <span class="nt">&quot;expires_in&quot;</span> <span class="p">:</span> <span class="mi">3600</span>
<span class="p">}</span>
</pre></div> <h5 id="avtomaticheskoe-poluchenie-tokena-dostupa"><a class="toclink" href="#avtomaticheskoe-poluchenie-tokena-dostupa">Автоматическое получение токена&nbsp;доступа</a></h5> <p>Получать этот токен доступа нужно будет каждые раз, при подключении к <code>api</code>. Для этого напишем простую функцию на <code>python 3</code> с использованием стандартной библиотеки <code>urllib.request</code></p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>


<span class="k">def</span> <span class="nf">get_auth_code</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Get access token for connect to youtube api &quot;&quot;&quot;</span>
    <span class="n">oauth_url</span> <span class="o">=</span> <span class="s1">&#39;https://accounts.google.com/o/oauth2/token&#39;</span>
    <span class="c1"># create post data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">refresh_token</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_REFRESH_TOKEN</span><span class="p">,</span>
        <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_CLIENT_ID</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_CLIENT_SECRET</span><span class="p">,</span>
        <span class="n">grant_type</span><span class="o">=</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="c1"># make request and take response</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">oauth_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c1"># get access_token from response</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
</pre></div> <h4 id="oauth2-avtorizatsiia"><a class="toclink" href="#oauth2-avtorizatsiia">Oauth2&nbsp;авторизация</a></h4> <p>Вот теперь, мы наконец подошли к самой <code>oauth2</code> авторизации в сервисах гугл. Для этого необходимо использовать следующие дополнительные&nbsp;библиотеки:</p> <ul> <li><a href="https://pypi.python.org/pypi/httplib2">httplib2</a></li> <li><a href="https://pypi.python.org/pypi/oauth2client">oauth2client</a></li> <li><a href="https://pypi.python.org/pypi/google-api-python-client">google-api-python-client</a></li> </ul> <p>Далее, используя выше описанную функцию получения временного токена, создаем подключение к <code>youtube api</code>.</p> <p>Вообще в руководстве по работе с <code>youtube api</code> рекомендуют использовать построение <code>oauth2</code> подключения с использованием объекта <code>flow_from_clientsecrets</code>, <a href="https://developers.google.com/youtube/v3/guides/uploading_a_video">примерно так</a>:</p> <div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_authenticated_service</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_from_clientsecrets</span><span class="p">(</span><span class="n">CLIENT_SECRETS_FILE</span><span class="p">,</span>
        <span class="n">scope</span><span class="o">=</span><span class="n">YOUTUBE_UPLOAD_SCOPE</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="n">MISSING_CLIENT_SECRETS_MESSAGE</span><span class="p">)</span>

    <span class="n">storage</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-oauth2.json&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">credentials</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">credentials</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">run_flow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">build</span><span class="p">(</span><span class="n">YOUTUBE_API_SERVICE_NAME</span><span class="p">,</span> <span class="n">YOUTUBE_API_VERSION</span><span class="p">,</span>
        <span class="n">http</span><span class="o">=</span><span class="n">credentials</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">()))</span>
</pre></div> <p>Но, как выяснилось на практике, такой подход, требует при каждой загрузки, давать разрешение на подключение к аккаунту <code>youtube</code> вручную, это не очень удобно. Учитывая, что можно замечательным образом получать токен авторизации, из обновляемого токена, мы будем использовать для создания <code>oauth2</code> подключения - объект <code>AccessTokenCredentials</code>.</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">httplib2</span>

<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">AccessTokenCredentials</span>
<span class="kn">from</span> <span class="nn">apiclient.discovery</span> <span class="kn">import</span> <span class="n">build</span>


<span class="k">def</span> <span class="nf">get_authenticated_service</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Create youtube oauth2 connection &quot;&quot;&quot;</span>
    <span class="c1"># make credentials with refresh_token auth</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">AccessTokenCredentials</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">get_auth_code</span><span class="p">(),</span> <span class="n">user_agent</span><span class="o">=</span><span class="s1">&#39;my-awesome-project/1.0&#39;</span>
    <span class="p">)</span>
    <span class="c1"># create connection to youtube api</span>
    <span class="k">return</span> <span class="n">build</span><span class="p">(</span>
        <span class="s1">&#39;youtube&#39;</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">,</span> <span class="n">http</span><span class="o">=</span><span class="n">credentials</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">())</span>
    <span class="p">)</span>
</pre></div> <p>Теперь мы имеем созданное подключение, которое можно использовать для работы с <code>api</code>.</p> <h2 id="zagruzka-video"><a class="toclink" href="#zagruzka-video">Загрузка&nbsp;видео</a></h2> <p>Имея готовое подключение к <code>api</code> загрузка видео происходит&nbsp;элементарно.</p> <p>Определим функцию инициализации загрузки, которая принимает в качестве аргументов подключение к <code>youtube api</code> и объект с информацией о&nbsp;видео.</p> <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">apiclient.http</span> <span class="kn">import</span> <span class="n">MediaFileUpload</span>


<span class="k">def</span> <span class="nf">initialize_upload</span><span class="p">(</span><span class="n">youtube</span><span class="p">,</span> <span class="n">card</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create youtube upload data &quot;&quot;&quot;</span>
    <span class="c1"># create video meta data</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">youtube_meta_data</span><span class="p">()</span>
    <span class="c1"># Call the API&#39;s videos.insert method to create and upload the video</span>
    <span class="n">insert_request</span> <span class="o">=</span> <span class="n">youtube</span><span class="o">.</span><span class="n">videos</span><span class="p">()</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="n">part</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
        <span class="n">media_body</span><span class="o">=</span><span class="n">MediaFileUpload</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">resumable</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="c1"># wait for file uploading</span>
    <span class="k">return</span> <span class="n">resumable_upload</span><span class="p">(</span><span class="n">insert_request</span><span class="p">)</span>
</pre></div> <p>Метод <code>youtube_meta_data</code> должен возвращать словарь описания видео согласно <a href="https://developers.google.com/youtube/v3/docs/videos">формату</a>,&nbsp;например:</p> <div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;snippet&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Summer vacation in California&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Had fun surfing in Santa Cruz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;surfing&quot;</span><span class="p">,</span> <span class="s2">&quot;Santa Cruz&quot;</span><span class="p">],</span>
        <span class="s2">&quot;categoryId&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;privacyStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;private&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> <p>В моем случае данный метод имел следующий&nbsp;вид:</p> <div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">youtube_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create metadata dict for youtube video upload &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">snippet</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_TITLE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">),</span>
                <span class="n">tags</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_TAGS</span><span class="p">,</span>
                <span class="n">categoryId</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_CATEGORY_ID</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;{desc}</span><span class="se">\n</span><span class="s1">{site_url}/{card_id}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">site_url</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SITE_URL</span><span class="p">,</span> <span class="n">card_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()),</span>
            <span class="p">),</span>
            <span class="n">status</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">privacyStatus</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_PRIVACY_STATUS</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">recordingDetails</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">latitude</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">latitude</span><span class="p">),</span>
                    <span class="n">longitude</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">longitude</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">)</span>
</pre></div> <p>После инициализации загрузки, необходимо поддерживать соединение и дождаться ответа от ютуба с идентификатором видео. Для этого будем использовать следующую&nbsp;функцию.</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">http</span>
<span class="kn">import</span> <span class="nn">httplib2</span>

<span class="c1"># Explicitly tell the underlying HTTP transport library not to retry, since we are handling retry logic ourselves.</span>
<span class="n">httplib2</span><span class="o">.</span><span class="n">RETRIES</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Maximum number of times to retry before giving up.</span>
<span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Always retry when these exceptions are raised.</span>
<span class="n">RETRIABLE_EXCEPTIONS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">httplib2</span><span class="o">.</span><span class="n">HttpLib2Error</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">NotConnected</span><span class="p">,</span>
    <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">IncompleteRead</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ImproperConnectionState</span><span class="p">,</span>
    <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">CannotSendRequest</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">CannotSendHeader</span><span class="p">,</span>
    <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ResponseNotReady</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BadStatusLine</span><span class="p">)</span>

<span class="c1"># Always retry when an apiclient.errors.HttpError with one of these status codes is raised.</span>
<span class="n">RETRIABLE_STATUS_CODES</span> <span class="o">=</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">resumable_upload</span><span class="p">(</span><span class="n">insert_request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">insert_request</span><span class="o">.</span><span class="n">next_chunk</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">RETRIABLE_STATUS_CODES</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">except</span> <span class="n">RETRIABLE_EXCEPTIONS</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">retry</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&gt;</span> <span class="n">MAX_RETRIES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Maximum retry are fail&#39;</span><span class="p">)</span>

            <span class="n">sleep_seconds</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">retry</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_seconds</span><span class="p">)</span>
</pre></div> <p>Таким образом, загрузка видео запускается функцией <code>initialize_upload</code>:</p> <div class="highlight"><pre><span></span><span class="n">video_id</span> <span class="o">=</span> <span class="n">initialize_upload</span><span class="p">(</span><span class="n">get_authenticated_service</span><span class="p">(),</span> <span class="n">card</span><span class="p">)</span>
</pre></div> <p>Полный код загрузки видео можно посмотреть в <a href="https://gist.github.com/Samael500/278dcea3bbb7c167dc5e">gist</a>.</p> <h2 id="sanktsii"><a class="toclink" href="#sanktsii">Санкции</a></h2> <p>Поскольку капиталистический запад, в лице корпорации зла, наложил на меня свои, безосновательные, <a href="https://maks.live/articles/drugoe/ura-menia-v-gugle-zabanili/">санкции</a>. Ограничив тем самым мое право доступа к свободной информации. Для работы с <code>youtube api</code> мне необходимо использовать <code>vpn</code> подключение.</p> <h4 id="vpn-soedinenie"><a class="toclink" href="#vpn-soedinenie"><span class="caps">VPN</span>&nbsp;соединение</a></h4> <p>В качестве <code>vpn</code> соединения я использую <code>ssh</code> туннель и локальное <code>socks5</code> прокси на 1080 порту. Включаю/отключаю <code>ssh</code> тунель при помощи библиотеки <code>subprocess</code>.</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>

<span class="c1"># init ssh connection</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;-fN&#39;</span><span class="p">,</span> <span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;1080&#39;</span><span class="p">,</span> <span class="s1">&#39;forward@vpn_connection&#39;</span><span class="p">])</span>

<span class="c1"># desctroy ssh connection</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;pkill&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;forward@vpn_connection&#39;</span><span class="p">])</span>
</pre></div> <h4 id="ne-pravilno"><a class="toclink" href="#ne-pravilno">Не&nbsp;правильно</a></h4> <p>Что бы подключиться к локальному <code>socks5</code> прокси, необходимо использовать библиотеку <a href="http://socksipy.sourceforge.net/">socksipy</a>, как показано в <a href="https://code.google.com/p/httplib2/wiki/Examples#Proxies">примере</a> работы с <code>httplib2</code>:</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">import</span> <span class="nn">socks</span>

<span class="n">h</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">(</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">ProxyInfo</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">PROXY_TYPE_SOCKS5</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">1080</span><span class="p">))</span>
<span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;https://l2.io/ip&#39;</span><span class="p">)</span>
</pre></div> <h4 id="pravilno"><a class="toclink" href="#pravilno">Правильно</a></h4> <p>Но, вышеуказанный способ не работает. Библиотека <code>socksipy</code> не поддерживает <code>python 3</code>, поэтому необходимо делать <a href="https://code.google.com/p/httplib2/issues/detail?id=205">по-другому</a>. Использовать библиотеку <a href="https://code.google.com/p/socksipy-branch/">socksipy-branch</a> (<a href="https://gist.github.com/Samael500/5a53b01db96f812ac530">gist зеркало</a>). И оборачивать <code>httplib2</code> с помощью метода <code>wrapmodule</code>:</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">httplib2</span>
<span class="kn">import</span> <span class="nn">socks</span>

<span class="n">socks</span><span class="o">.</span><span class="n">setdefaultproxy</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">PROXY_TYPE_SOCKS5</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">1080</span><span class="p">)</span>
<span class="n">socks</span><span class="o">.</span><span class="n">wrapmodule</span><span class="p">(</span><span class="n">httplib2</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">()</span>
<span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;https://l2.io/ip&#39;</span><span class="p">)</span>
</pre></div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
                    var disqus_identifier = "articles/python/zagruzka-video-na-youtube/";
                    (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//samael500.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script> </div> </div> <div class="col-md-3 content-right"> <div class="anchorific"></div> </div> </div> </div> </div> </div> <div class="footer"> <div class="container"> <p>This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.</p> <p><a href="http://github.com/samael500/w3-personal-blog/">W3 Personal Blog</a> is a flat <a href="http://getbootstrap.com/">bootstrap</a> responsive theme designed by <a href="https://w3layouts.com/personal-blog-a-blogging-category-flat-bootstrap-responsive-web-template/">W3layouts</a> ported to a pelican by <a href="http://samael500.github.io/">Samael500</a>.<p> <p>Copyrights &copy; 2015&mdash;2017 Maks live All rights reserved.</p> <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="Creative Commons License" style="border-width:0" src="/media/by-nc-sa.svg"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p> </div> </div> <script type="text/javascript" src="https://www.l2.io/ip.js?var=userip"></script> <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter32194009 = new Ya.Metrika({
                    id:32194009,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true,
                    params:{'ip': userip}
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script> <noscript><div><img src="https://mc.yandex.ru/watch/32194009" style="position:absolute; left:-9999px;" alt></div></noscript> <script>
        (function(w, d, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    var options = {
                        project: '987654231',
                        attributes_dataset: [
                            'cerber-event',
                            'cerber-head',
                            'second-cerber-event',
                            'cerber-topline'
                        ],
                        custom_vars: {
                            'test_key1': 'test_val1',
                            'test_key2': 'test_val2'
                        },
                        trackLinks: true,
                        splits: ['some_split']
                    };
                    w.top100Counter = new top100(
                        options
                    );

                    w.top100Counter.sendCustomVars({'test=test.,!@#$%^&*()_test': 'test=test.,!@#$%^&*()_test'});
                } catch (e) {
                    console.log(e);
                }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function() {
                    n.parentNode.insertBefore(s, n);
                };
            s.type = "text/javascript";
            s.async = true;
            s.src =
                (d.location.protocol == "https:" ? "http:" : "http:") + "//st.top100.ru/top100/top100.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else {
                f();
            }
        })(window, document, "_top100q");
</script> <script type="text/javascript">
    var disqus_shortname = 'samael500';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> </body> </html>