<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Maks" />
    <meta name="robots" content="index, follow"/>
    <meta name="keywords" content="Samael500 personal blog" />

    <meta property="og:title" content="Загрузка видео на youtube"/>
    <meta property="og:url" content="http://samael500.github.io/articles/python/zagruzka-video-na-youtube/"/>
    <meta property="og:site_name" content="Maks blog"/>
    <meta property="og:type" content="article"/>

    <link rel="canonical" href="http://samael500.github.io/articles/python/zagruzka-video-na-youtube/" />

    <title>Загрузка видео на youtube | Maks blog</title>

    <link rel="stylesheet" type="text/css" href="http://samael500.github.io/theme/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="http://samael500.github.io/theme/css/style.css" />
    <link rel="stylesheet" type="text/css" href="http://samael500.github.io/theme/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="http://samael500.github.io/theme/css/pygment.css" />

    <script type="text/javascript" src="http://samael500.github.io/theme/js/jquery.min.js"></script>
    <script type="text/javascript" src="http://samael500.github.io/theme/js/move-top.js"></script>
    <script type="text/javascript" src="http://samael500.github.io/theme/js/easing.js"></script>


    <script type="text/javascript">var switchTo5x=true;</script>



    <script type="text/javascript" src="/emojify/js/emojify.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/emojify/css/emojify.min.css" />
    <script type="text/javascript">
        emojify.setConfig({
            img_dir : '/emojify/images',
            ignore_emoticons: true,
        });
        $(document).ready(function() {
            emojify.run(document.getElementsByTagName('article')[0]);
        });
    </script>

</head>
<body id="index">
    <a class="hidden-phone" href="https://github.com/Samael500">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png">
    </a>
<div class="header">  
    <div class="container">
        <div class="logo">
            <a href="http://samael500.github.io/">
                MAKS BLOG            </a>
        </div>

        <div class="top-menu">

            <div class="search">
            </div>

            <span class="menu"> </span>
                <ul>
                            <li ><a href="http://samael500.github.io/category/github.html">Github</a></li>
                            <li class="active"><a href="http://samael500.github.io/category/python.html">Python</a></li>

                    <div class="clearfix"></div>
                </ul>
            </div>

            <div class="clearfix"></div>

            <script>
                $("span.menu").click(function(){
                    $(".top-menu ul").slideToggle("slow" , function(){
                    });
                });
            </script>
        </div>
    </div>
</div>
    <div class="content">
        <div class="container">
            <div class="content-grids">
<div class="single-main">

    <div class="col-md-12 single-grid">

        <header>
<h4>
    <a href="http://samael500.github.io/articles/python/zagruzka-video-na-youtube/" title="Загрузка видео на youtube">Загрузка видео на&nbsp;youtube</a>
    Авг. 22, 2015
</h4>

<div class="footer art-info">

        Автор: <a class="url fn" href="http://samael500.github.io/author/maks/">Maks</a> |

    Категория: <a href="http://samael500.github.io/category/python.html">Python</a>

        | Теги:         <a href="http://samael500.github.io/tag/python/">python</a>
        <a href="http://samael500.github.io/tag/youtube/">youtube</a>
        <a href="http://samael500.github.io/tag/oauth2/">oauth2</a>
        <a href="http://samael500.github.io/tag/video-upload/">video upload</a>


        | <a href="http://samael500.github.io/articles/python/zagruzka-video-na-youtube/#disqus_thread">Комментарии</a>

</div>        </header>

        <div class="entry-content">


            <h1></h1>
<p>В одном из моих собственных проектов, возникла задача - автоматической
загрузки видео на канал на <code>youtube</code>. Делается это достаточно просто, при
помощи гугловского <code>api</code> клиента для <code>python</code>. Единственное затруднение
вызвало полумагическое получение ключей доступа к <code>api</code>.</p>
<h2>Авторизация</h2>
<blockquote>
<p>Все коды доступа и ключи авторизации, использованные в статье, вымышленные.
Любое совпадение с реально существующими или когда-либо существовавшими
ключами&nbsp;случайно.</p>
</blockquote>
<p>Для авторизации в сервисах google с помощью протокола
<a href="http://oauth.net/2/">oauth2</a> необходимо зарегистрировать приложение и дать
ему соответсвующие права. Для этого нужно перейти в
<a href="https://console.developers.google.com/project">консоль&nbsp;разработчика</a></p>
<p>Нажимаем на кнопку <code>Create Project</code>, выбираем имя и создаем новое приложение.
После того как приложение будет создано, нужно добавить ему необходимые
доступы к google <span class="caps">API</span>.</p>
<p><img alt="Create Project" class="shadow center" src="/media/youtube-upload/create_proj.png" /></p>
<p>Для загрузки видео на <code>youtube</code> нужно добавить <code>YouTube Data API</code>.
Для этого переходим во вкладку <code>APIs &amp; auth</code> &rarr; <code>APIs</code>.
Также во вкладке <code>APIs &amp; auth</code> &rarr; <code>Credentials</code> нужно добавить доступы
для <code>oauth2</code> авторизации.</p>
<p><img alt="Add Oauth2" class="shadow center" src="/media/youtube-upload/oauth_cred.png" /></p>
<p>Указываем тип приложения <code>Other</code>.
Получаем доступы для авторизации: идентефикатор и&nbsp;пароль.</p>
<ul>
<li>Client <span class="caps">ID</span> <code>230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com</code></li>
<li>Client secret <code>qawsWCd3J6HTRvnqsjYUpgH9</code></li>
</ul>
<p>Получив данные для авторизации, нужно перейти по следующей ссылке, заменив в ней
параметр <code>client_id</code> на тот что Вы получили в предыдущем&nbsp;шаге.</p>
<div class="highlight"><pre>    https://accounts.google.com/o/oauth2/auth?
        client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;
        redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;
        scope=https://www.googleapis.com/auth/youtube&amp;
        response_type=code&amp;
        access_type=offline
</pre></div>


<p>Далее выбираем к какому аккаунту гугл будет иметь доступ приложение,
и соответсвенно к какому каналу на&nbsp;ютубе.</p>
<p><img alt="account choice" class="shadow center" src="/media/youtube-upload/account_choice.png" /></p>
<p><img alt="ch choice" class="shadow center" src="/media/youtube-upload/ch_choice.png" /></p>
<p>Соглашаемся с доступом к управлению&nbsp;каналом.</p>
<p><img alt="access" class="shadow center" src="/media/youtube-upload/access.png" /></p>
<p>Получаем токен авторизации следующего вида
<code>4/Rw6A9raJQ3PrPWL0Q9z49guYu89FZoz322RySVFtzNc</code>.</p>
<p><img alt="code" class="shadow center" src="/media/youtube-upload/code.png" /></p>
<p>После этого необходимо получить, так называемый, refresh_token, для этого нужно
отправить <span class="caps">POST</span> запрос c токеном авторизации по адресу
<code>https://accounts.google.com/o/oauth2/token</code>. Cделать это легко, при помощи
консольной утилиты&nbsp;curl.</p>
<div class="highlight"><pre><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="se">\</span>
<span class="s2">&quot;code=4/Rw6A9raJQ3PrPWL0Q9z49guYu89FZoz322RySVFtzNc&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_secret=qawsWCd3J6HTRvnqsjYUpgH9&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;grant_type=authorization_code&quot;</span>

curl --data <span class="nv">$data</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/token&quot;</span>
</pre></div>


<p>Токен авторизации сработает только один раз, при повторной попытке отправить
его будет получено <code>Code was already redeemed.</code>.
В ответ на корректный запрос, гугл возвращает json с временным токеном доступа
и постоянным обновляемым токеном (собственно он нам и&nbsp;нужен).</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;access_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;ya29.1wGYJU7NP7Ul69c13aE1Vuvbx0LfxrsgMiBjXdNY3sU3tuE9LmuJ3nOGHeb3e_824LH0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;token_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
    <span class="nt">&quot;expires_in&quot;</span> <span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="nt">&quot;refresh_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;1/g1ixyts83iMrtR71oFqwGp3LSGbHz6ByxsBThrHRWCNIgOrJDtdun6zK6XiATCKT&quot;</span>
<span class="p">}</span>
</pre></div>


<p>Получив обновляемый токен, можем с его помощью каждый раз получать рабочий
токен доступа, который предоставляется временем на 3600&nbsp;секунд.</p>
<div class="highlight"><pre><span class="nv">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="se">\</span>
<span class="s2">&quot;refresh_token=1/g1ixyts83iMrtR71oFqwGp3LSGbHz6ByxsBThrHRWCNIgOrJDtdun6zK6XiATCKT&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_id=230452130504-3uca1rp4ntlh06hdnsdbj50sqagaqfkt.apps.googleusercontent.com&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;client_secret=qawsWCd3J6HTRvnqsjYUpgH9&amp;&quot;</span><span class="se">\</span>
<span class="s2">&quot;grant_type=refresh_token&quot;</span>

curl --data <span class="nv">$data</span> <span class="s2">&quot;https://accounts.google.com/o/oauth2/token&quot;</span>
</pre></div>


<p>В ответ гугл возвращает json с временным токеном&nbsp;доступа.</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;access_token&quot;</span> <span class="p">:</span> <span class="s2">&quot;ya29.2AHpPjacO0prQkip0svapohuZtoK0wqdh7u0ohH49l0WWwrSyss7CWiwzMy5wX967tWsjQ&quot;</span><span class="p">,</span>
  <span class="nt">&quot;token_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
  <span class="nt">&quot;expires_in&quot;</span> <span class="p">:</span> <span class="mi">3600</span>
<span class="p">}</span>
</pre></div>


<p>Получать этот токен доступа нужно будет каждые раз, при подключении к <code>api</code>.
Для этого напишем простую функицю на <code>python 3</code> с использованием стандартной
библиотеки <code>urllib.request</code></p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>


<span class="k">def</span> <span class="nf">get_auth_code</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Get access token for connect to youtube api &quot;&quot;&quot;</span>
    <span class="n">oauth_url</span> <span class="o">=</span> <span class="s">&#39;https://accounts.google.com/o/oauth2/token&#39;</span>
    <span class="c"># create post data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">refresh_token</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_REFRESH_TOKEN</span><span class="p">,</span>
        <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_CLIENT_ID</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">YOUTUBE_CLIENT_SECRET</span><span class="p">,</span>
        <span class="n">grant_type</span><span class="o">=</span><span class="s">&#39;refresh_token&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
        <span class="s">&#39;Accept&#39;</span><span class="p">:</span> <span class="s">&#39;application/json&#39;</span>
    <span class="p">}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="c"># make request and take response</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">oauth_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="c"># get access_token from response</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">]</span>
</pre></div>


<p>Вот теперь, мы наконец подошли к самой <code>oauth2</code> авторизации в сервисах гугл.
Для этого необходимо использовать следующие дополнительные&nbsp;библиотеки:</p>
<ul>
<li><a href="https://pypi.python.org/pypi/httplib2">httplib2</a></li>
<li><a href="https://pypi.python.org/pypi/oauth2client">oauth2client</a></li>
<li><a href="https://pypi.python.org/pypi/google-api-python-client">google-api-python-client</a></li>
</ul>
<p>Далее, используя выше описанную функцию получения временного токена, создаем
подключение к <code>youtube api</code>.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">httplib2</span>

<span class="kn">from</span> <span class="nn">oauth2client.client</span> <span class="kn">import</span> <span class="n">AccessTokenCredentials</span>
<span class="kn">from</span> <span class="nn">apiclient.discovery</span> <span class="kn">import</span> <span class="n">build</span>


<span class="k">def</span> <span class="nf">get_authenticated_service</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Create youtube oauth2 connection &quot;&quot;&quot;</span>
    <span class="c"># make credentials with refresh_token auth</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="n">AccessTokenCredentials</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">get_auth_code</span><span class="p">(),</span> <span class="n">user_agent</span><span class="o">=</span><span class="s">&#39;my-awesome-project/1.0&#39;</span>
    <span class="p">)</span>
    <span class="c"># create connection to youtube api</span>
    <span class="k">return</span> <span class="n">build</span><span class="p">(</span>
        <span class="s">&#39;youtube&#39;</span><span class="p">,</span> <span class="s">&#39;v3&#39;</span><span class="p">,</span> <span class="n">http</span><span class="o">=</span><span class="n">credentials</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">httplib2</span><span class="o">.</span><span class="n">Http</span><span class="p">())</span>
    <span class="p">)</span>
</pre></div>


<p>Теперь мы имеем созданное подключение, которое можно использовать для работы с <code>api</code>.</p>
<h2>Загрузка&nbsp;видео</h2>
<p>&#8230;продолжение&nbsp;следует&#8230;</p>


        </div>

            <div class="clearfix"></div>

            <div class="content-form">
                <h3>Обсуждения</h3>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_identifier = "articles/python/zagruzka-video-na-youtube/";
                    (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//samael500.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
            </div>

    </div>
</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>Copyrights © 2015 Blog All rights reserved | Template by <a href="http://w3layouts.com/">W3layouts</a></p>
        </div>
    </div>

<script type="text/javascript">
    var disqus_shortname = 'samael500';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <script src="//code.jquery.com/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
</body>
</html>