<!DOCTYPE html>
<html lang="ru"> <head><title>Сам себе почтальон | Maks live</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#00aeff"><meta name="msapplication-navbutton-color" content="#00aeff"><meta name="apple-mobile-web-app-status-bar-style" content="#00aeff"><meta name="author" content="Maks"><meta name="robots" content="index, follow"><meta name="keywords" content="article, postfix, email, python, dkim, spf"><meta name="description" content="Каждый раз при запуске проекта в продакшн, встает вопрос, как отправлять письма с боевого сервера. Есть множество удобных сервисов, таких как mailgun или mailjet, можно отправлять письма со своего домена через smtp Яндекса. Но иногда нужно организовать свой почтовый сервер и рассылать письма через него."><meta property="og:title" content="Сам себе почтальон"><meta property="og:url" content="https://maks.live/articles/drugoe/sam-sebe-pochtalon/"><meta property="og:site_name" content="Maks live"><meta property="og:type" content="article"><meta property="og:image" content="https://maks.live/media/postfix/postfix.png"><meta property="og:description" content="Каждый раз при запуске проекта в продакшн, встает вопрос, как отправлять письма с боевого сервера. Есть множество удобных сервисов, таких как mailgun или mailjet, можно отправлять письма со своего домена через smtp Яндекса. Но иногда нужно организовать свой почтовый сервер и рассылать письма через него."><meta property="og:image:width" content="1280"><meta property="og:image:height" content="791"><link rel="canonical" href="https://maks.live/articles/drugoe/sam-sebe-pochtalon/"><link rel="stylesheet" type="text/css" href="/theme/css/bootstrap.css"><link rel="stylesheet" type="text/css" href="/theme/css/font-awesome.css"><link rel="stylesheet" type="text/css" href="/theme/css/style.css"><link rel="stylesheet" type="text/css" href="/theme/css/pygment.css"><link rel="stylesheet" type="text/css" href="/theme/css/social-likes_flat.css"><script type="text/javascript" src="/theme/js/jquery.min.js"></script><script type="text/javascript" src="/theme/js/bootstrap.min.js"></script><script type="text/javascript" src="/theme/js/social-likes.min.js"></script><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/tree.css"><link rel="stylesheet" type="text/css" href="https://maks.live/theme/css/anchorific.css"><script type="text/javascript" src="https://maks.live/theme/js/anchorific.js"></script></head> <body id="index"> <a class="forkmegithub" href="https://github.com/Samael500"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"> </a> <div class="header"> <div class="container"> <div class="logo"> <a href="https://maks.live/"> MAKS LIVE<br><small>samael500 blog</small> </a> </div> <div class="top-menu"> <div class="search"> <script>
  (function() {
    var cx = '006263355362628034990:cuxoisonrno';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script> <form id="searchbox_006263355362628034990:cuxoisonrno" action="https://www.google.com/"> <input value="006263355362628034990:cuxoisonrno" name="cx" type="hidden"> <input value="FORID:11" name="cof" type="hidden"> <input id="q" name="q" type="text" required> <input type="submit" value> </form> </div> <span class="menu"> </span> <ul> <li> <a href="/">HOME</a></li> <li> <a href="/tag/best/">BEST</a></li> <li><a href="https://maks.live/about/">ABOUT</a></li> <div class="clearfix"></div> </ul> </div> <div class="clearfix"></div> <script>
                $("span.menu").click(function(){
                    $(".top-menu ul").slideToggle("slow" , function(){
                    });
                });
            </script> </div> </div> </div> <div class="content"> <div class="container"> <div class="content-grids"> <div class="single-main"> <div class="col-md-9 single-grid"> <header> <h4> <a href="https://maks.live/articles/drugoe/sam-sebe-pochtalon/" title="Сам себе почтальон">Сам себе&nbsp;почтальон</a> Feb 28, 2017 </h4> <div class="footer art-info"> Author: <a class="url fn" href="https://maks.live/author/maks/">Maks</a> | Category: <a href="https://maks.live/category/drugoe.html">Другое</a> | <a href="https://maks.live/articles/drugoe/sam-sebe-pochtalon/#disqus_thread">Comments</a> <br> Tags: <a href="https://maks.live/tag/postfix/">postfix</a> <a href="https://maks.live/tag/email/">email</a> <a href="https://maks.live/tag/python/">python</a> <a href="https://maks.live/tag/dkim/">dkim</a> <a href="https://maks.live/tag/spf/">spf</a> </div><div class="social-likes"> <div class="vkontakte" title="Поделиться ссылкой во Вконтакте">Вконтакте</div> <div class="twitter" data-via="samael500" title="Поделиться ссылкой в Твиттере">Twitter</div> <div class="facebook" title="Поделиться ссылкой на Фейсбуке">Facebook</div> <div class="plusone" title="Поделиться ссылкой в Google+">Google+</div> </div> </header> <article class="content"> <p>Каждый раз при запуске проекта в продакшн, встает вопрос, как отправлять письма с боевого сервера. Есть множество удобных сервисов, таких как <a href="https://www.mailgun.com/">mailgun</a> или <a href="https://www.mailjet.com/">mailjet</a>, можно отправлять письма со своего домена через <code>smtp</code> <a href="https://pdd.yandex.ru/">Яндекса</a>. Но иногда нужно организовать свой почтовый сервер и рассылать письма через&nbsp;него.</p> <p>На этапе разработки проекта в качестве почтового сервера мы используем <a href="https://debugmail.io">DebugMail</a> сервис, который позволяет без настройки своего <code>smtp</code> сервера отправлять тестовые <a href="https://debugmail.io/mails/ec14ea018ee2944ff36776c9f1ba1b186984df8a">письма</a>.</p> <p><img alt="Debug Mail" class="center" src="/media/postfix/dm.png"></p> <h2 id="pisma-pisma-lichno-na-pochtu-noshu"><a class="toclink" href="#pisma-pisma-lichno-na-pochtu-noshu">Письма, письма лично на почту&nbsp;ношу&#8230;</a></h2> <p>Установим свой почтовый сервер, будем использовать простой и удобный <a href="http://www.postfix.org/">PostFix</a>.</p> <div class="highlight"><pre><span></span>$ sudo apt-get install postfix
</pre></div> <p>В интерактивном режиме указываем тип и домен нашего&nbsp;сервера.</p> <p><img alt="Configure Postfix" class="center" src="/media/postfix/ps-configure.png"></p> <p><img alt="Postfix domain" class="center" src="/media/postfix/ps-domain.png"></p> <p>Для дальнейшей настройки скопируем базовый конфигурационный файл для <code>debian</code>. И добавим доступ только из локального&nbsp;хоста.</p> <div class="highlight"><pre><span></span>$ sudo cp /usr/share/postfix/main.cf.debian /etc/postfix/main.cf
$ <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</span>
<span class="s2">mydestination = localhost</span>
<span class="s2">&quot;</span> <span class="p">|</span> sudo tee -a /etc/postfix/main.cf
$ sudo service postfix reload
</pre></div> <p>По умолчанию у <code>postfix</code> открыт 25 порт из внешнего мира, закроем его, отредактировав <code>/etc/postfix/master.cf</code>.</p> <div class="highlight"><pre><span></span><span class="gd">--- /etc/postfix/master.cf</span>
<span class="gi">+++ /etc/postfix/master.cf</span>
<span class="gu">@@ -10,7 +10,7 @@</span>
 #               (yes)   (yes)   (yes)   (never) (100)
 # ==========================================================================
 # smtp      inet  n       -       -       -       -       smtpd
<span class="gd">-smtp               inet  n       -       n       -       -       smtpd</span>
<span class="gi">+127.0.0.1:smtp     inet  n       -       n       -       -       smtpd</span>
 #smtp      inet  n       -       -       -       1       postscreen
 #smtpd     pass  -       -       -       -       -       smtpd
 #dnsblog   unix  -       -       -       -       0       dnsblog
</pre></div> <p>Теперь можем попробовать отправить свое первое письмо с собственного сервера. Воспользуемся для этого стандартной библиотекой <code>python</code> <a href="https://docs.python.org/3.6/library/smtplib.html">SMTPLib</a>.</p> <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>

<span class="n">text_part</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="s1">&#39;There are test mail text content&#39;</span><span class="p">,</span> <span class="s1">&#39;plain&#39;</span><span class="p">)</span>
<span class="n">html_part</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;html&gt;</span>
<span class="s1">  &lt;head&gt;&lt;/head&gt;</span>
<span class="s1">  &lt;body&gt;</span>
<span class="s1">    &lt;h1&gt;Hello from Earth&lt;h1&gt;</span>
<span class="s1">    &lt;p&gt;There are test mail html content.&lt;/p&gt;</span>
<span class="s1">    &lt;p style=&quot;color:red&quot;&gt;have a good day ;)&lt;/p&gt;</span>
<span class="s1">  &lt;/body&gt;</span>
<span class="s1">&lt;/html&gt;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>

<span class="n">from_</span><span class="p">,</span> <span class="n">to_</span> <span class="o">=</span> <span class="s1">&#39;from@some.com&#39;</span><span class="p">,</span> <span class="s1">&#39;to@other.org&#39;</span>

<span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">(</span><span class="s1">&#39;alternative&#39;</span><span class="p">)</span>

<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hello from Earth&#39;</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">from_</span>
<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_</span>

<span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">text_part</span><span class="p">)</span>
<span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">html_part</span><span class="p">)</span>

<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="p">[</span><span class="n">to_</span><span class="p">],</span> <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
<span class="n">conn</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div> <p>Письмо успешно отправляется и обязательно попадает в спам, т.к. выглядит очень подозрительно и отправлено с неподтвержденного&nbsp;адреса.</p> <p><img alt="gmail spam" class="center shadow" src="/media/postfix/gmail.png"></p> <p>Подключим <code>tls</code> шифрование писем, добавив следующие строки в <code>/etc/postfix/main.cf</code></p> <div class="highlight"><pre><span></span><span class="k">smtpd_tls_security_level</span> <span class="o">=</span> <span class="k">may</span>
<span class="k">smtp_tls_security_level</span> <span class="o">=</span> <span class="k">may</span>
<span class="k">smtp_tls_loglevel</span> <span class="o">=</span> <span class="m">1</span>
<span class="k">smtpd_tls_loglevel</span> <span class="o">=</span> <span class="m">1</span>

<span class="k">smtpd_tls_CAfile</span> <span class="o">=</span> <span class="n">/etc/letsencrypt/live/example.com/chain.pem</span>
<span class="k">smtpd_tls_cert_file</span> <span class="o">=</span> <span class="n">/etc/letsencrypt/live/example.com/cert.pem</span>
<span class="k">smtpd_tls_key_file</span> <span class="o">=</span> <span class="n">/etc/letsencrypt/live/example.com/privkey.pem</span>

<span class="k">smtp_tls_session_cache_database</span> <span class="o">=</span> <span class="k">btree</span><span class="err">:</span><span class="n">/var/lib/postfix/smtp_scache</span>

<span class="k">smtp_tls_mandatory_exclude_ciphers</span> <span class="o">=</span> <span class="k">aNULL</span><span class="p">,</span> <span class="k">MD</span><span class="m">5</span> <span class="p">,</span> <span class="k">DES</span><span class="p">,</span> <span class="k">ADH</span><span class="p">,</span> <span class="k">RC</span><span class="m">4</span><span class="p">,</span> <span class="k">PSD</span><span class="p">,</span> <span class="k">SRP</span><span class="p">,</span> <span class="m">3</span><span class="k">DES</span><span class="p">,</span> <span class="k">eNULL</span>
<span class="k">smtp_tls_mandatory_protocols</span> <span class="o">=</span> <span class="err">!</span><span class="k">SSLv</span><span class="m">2</span><span class="p">,</span> <span class="err">!</span><span class="k">SSLv</span><span class="m">3</span><span class="p">,</span> <span class="err">!</span><span class="k">TLSv</span><span class="m">1</span><span class="p">,</span> <span class="err">!</span><span class="k">TLSv</span><span class="m">1</span><span class="k">.</span><span class="m">1</span>
<span class="k">smtp_tls_protocols</span><span class="o">=</span><span class="err">!</span><span class="k">SSLv</span><span class="m">2</span><span class="p">,</span> <span class="err">!</span><span class="k">SSLv</span><span class="m">3</span><span class="p">,</span> <span class="err">!</span><span class="k">TLSv</span><span class="m">1</span><span class="p">,</span> <span class="err">!</span><span class="k">TLSv</span><span class="m">1</span><span class="k">.</span><span class="m">1</span>
<span class="k">smtp_tls_mandatory_ciphers</span><span class="o">=</span><span class="k">high</span>
<span class="k">tls_high_cipherlist</span><span class="o">=</span><span class="k">EDH</span><span class="o">+</span><span class="k">CAMELLIA</span><span class="err">:</span><span class="k">EDH</span><span class="o">+</span><span class="k">aRSA</span><span class="err">:</span><span class="k">EECDH</span><span class="o">+</span><span class="k">aRSA</span><span class="o">+</span><span class="k">AESGCM</span><span class="err">:</span><span class="k">EECDH</span><span class="o">+</span><span class="k">aRSA</span><span class="o">+</span><span class="k">SHA</span><span class="m">384</span><span class="err">:</span><span class="k">EECDH</span><span class="o">+</span><span class="k">aRSA</span><span class="o">+</span><span class="k">SHA</span><span class="m">256</span><span class="err">:</span><span class="k">EECDH</span><span class="err">:</span><span class="o">+</span><span class="k">CAMELLIA</span><span class="m">256</span><span class="err">:</span><span class="o">+</span><span class="k">AES</span><span class="m">256</span><span class="err">:</span><span class="o">+</span><span class="k">CAMELLIA</span><span class="m">128</span><span class="err">:</span><span class="o">+</span><span class="k">AES</span><span class="m">128</span><span class="err">:</span><span class="o">+</span><span class="k">SSLv</span><span class="m">3</span><span class="err">:!</span><span class="k">aNULL</span><span class="err">:!</span><span class="k">eNULL</span><span class="err">:!</span><span class="k">LOW</span><span class="err">:!</span><span class="m">3</span><span class="k">DES</span><span class="err">:!</span><span class="k">MD</span><span class="m">5</span><span class="err">:!</span><span class="k">EXP</span><span class="err">:!</span><span class="k">PSK</span><span class="err">:!</span><span class="k">DSS</span><span class="err">:!</span><span class="k">RC</span><span class="m">4</span><span class="err">:!</span><span class="k">SEED</span><span class="err">:!</span><span class="k">ECDSA</span><span class="err">:</span><span class="k">CAMELLIA</span><span class="m">256</span><span class="k">-SHA</span><span class="err">:</span><span class="k">AES</span><span class="m">256</span><span class="k">-SHA</span><span class="err">:</span><span class="k">CAMELLIA</span><span class="m">128</span><span class="k">-SHA</span><span class="err">:</span><span class="k">AES</span><span class="m">128</span><span class="k">-SHA</span>
<span class="k">tls_random_source</span> <span class="o">=</span> <span class="k">dev</span><span class="err">:</span><span class="n">/dev/urandom</span>
</pre></div> <p>Здесь нам понадобятся сертификаты, можно подписать их самостоятельно, но проще и надежнее использовать бесплатные сертификаты от <a href="https://letsencrypt.org/">Let’s Encrypt</a>. Подробнее о том как их получать в статье <a href="https://maks.live/articles/secure/davaite-shifrovat/">Давайте шифровать</a>.</p> <p>После настройки перезапускаем <code>postfix</code> и проверяем доступность <code>tls</code>.</p> <div class="highlight"><pre><span></span>$ openssl s_client -starttls smtp -showcerts -connect localhost:25

CONNECTED<span class="o">(</span><span class="m">00000003</span><span class="o">)</span>
<span class="nv">depth</span><span class="o">=</span><span class="m">1</span> <span class="nv">C</span> <span class="o">=</span> US, <span class="nv">O</span> <span class="o">=</span> Let<span class="s1">&#39;s Encrypt, CN = Let&#39;</span>s Encrypt Authority X3
verify error:num<span class="o">=</span><span class="m">20</span>:unable to get <span class="nb">local</span> issuer certificate
---
Certificate chain
 <span class="m">0</span> s:/CN<span class="o">=</span>example.com
   i:/C<span class="o">=</span>US/O<span class="o">=</span>Let<span class="s1">&#39;s Encrypt/CN=Let&#39;</span>s Encrypt Authority X3
-----BEGIN CERTIFICATE-----
&lt;cert content&gt;
-----END CERTIFICATE-----
 <span class="m">1</span> s:/C<span class="o">=</span>US/O<span class="o">=</span>Let<span class="s1">&#39;s Encrypt/CN=Let&#39;</span>s Encrypt Authority X3
   i:/O<span class="o">=</span>Digital Signature Trust Co./CN<span class="o">=</span>DST Root CA X3
-----BEGIN CERTIFICATE-----
&lt;cert content&gt;
-----END CERTIFICATE-----
---
Server certificate
<span class="nv">subject</span><span class="o">=</span>/CN<span class="o">=</span>example.com
<span class="nv">issuer</span><span class="o">=</span>/C<span class="o">=</span>US/O<span class="o">=</span>Let<span class="s1">&#39;s Encrypt/CN=Let&#39;</span>s Encrypt Authority X3
---
No client certificate CA names sent
Peer signing digest: SHA512
Server Temp Key: ECDH, P-256, <span class="m">256</span> bits
---
SSL handshake has <span class="nb">read</span> <span class="m">3884</span> bytes and written <span class="m">468</span> bytes
---
New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-GCM-SHA384
Server public key is <span class="m">4096</span> bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES256-GCM-SHA384
    Session-ID: 9C05050D143CE1474438AEC0A57BD8303953053608ECD5775B565A26455EDADB
    Session-ID-ctx: 
    Master-Key: D6A09F3AC016E489542EAA11E9EFF7B56118D24F849FD480B26E219322E8D97D43DE7C537E9B928A67DDCAD3F9397EC6
    Key-Arg   : None
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: <span class="m">7200</span> <span class="o">(</span>seconds<span class="o">)</span>
    TLS session ticket:
    <span class="m">0000</span> - <span class="nb">cd</span> a5 c1 <span class="m">43</span> <span class="m">13</span> c9 2c 4b-7e <span class="m">14</span> f6 <span class="m">53</span> <span class="m">92</span> <span class="m">86</span> <span class="m">89</span> <span class="m">29</span>   ...C..,K~..S...<span class="o">)</span>
    <span class="m">0010</span> - <span class="m">88</span> dc ae cc d4 <span class="m">61</span> a1 4c-ec <span class="m">05</span> b1 <span class="m">61</span> <span class="m">94</span> 0c b1 6c   .....a.L...a...l
    <span class="m">0020</span> - <span class="m">13</span> <span class="m">57</span> <span class="m">84</span> <span class="m">63</span> 0f e4 6a d7-da <span class="m">08</span> <span class="m">45</span> 7e <span class="m">80</span> 3e fd d7   .W.c..j...E~.&gt;..
    <span class="m">0030</span> - <span class="m">16</span> <span class="m">82</span> <span class="m">70</span> d5 e4 8a bd ba-6f 9d b9 6f d9 <span class="m">49</span> <span class="m">56</span> b7   ..p.....o..o.IV.
    <span class="m">0040</span> - d4 <span class="m">41</span> 5a c7 <span class="m">27</span> <span class="m">53</span> <span class="m">82</span> b5-8d 5d <span class="m">22</span> <span class="m">08</span> <span class="m">38</span> 3c a5 <span class="m">59</span>   .AZ.<span class="err">&#39;</span>S...<span class="o">]</span><span class="s2">&quot;.8&lt;.Y</span>
<span class="s2">    0050 - 6b 06 e7 5f ba 36 2f 91-44 85 7a 5d 1c e4 da d9   k.._.6/.D.z]....</span>
<span class="s2">    0060 - 90 78 64 10 63 6a df c9-79 8d d9 10 66 dc 24 74   .xd.cj..y...f.</span><span class="nv">$t</span><span class="s2"></span>
<span class="s2">    0070 - fb 5a f6 f5 02 14 c5 d5-b0 b3 65 57 24 01 f2 bd   .Z........eW</span>$<span class="s2">...</span>
<span class="s2">    0080 - 06 31 f9 a9 e3 32 42 ad-f0 3b b5 3d 39 77 2c 95   .1...2B..;.=9w,.</span>
<span class="s2">    0090 - 8f fd e9 4f c9 4c 1d 77-8e 23 e4 ca 48 e8 9f ed   ...O.L.w.#..H...</span>

<span class="s2">    Start Time: 1489229346</span>
<span class="s2">    Timeout   : 300 (sec)</span>
<span class="s2">    Verify return code: 20 (unable to get local issuer certificate)</span>
<span class="s2">---</span>
<span class="s2">250 DSN</span>

<span class="s2">QUIT</span>
<span class="s2">DONE</span>
</pre></div> <h2 id="podpisyvaius-pod-kazhdym-slovom"><a class="toclink" href="#podpisyvaius-pod-kazhdym-slovom">Подписываюсь под каждым&nbsp;словом&#8230;</a></h2> <p>На сегодняшний день, считается обязательной подпись электронных писем с помощью <a href="http://www.dkim.org/"><span class="caps">DKIM</span></a>. Это делается для того, чтобы почтовый сервер получателя мог удостоверится в том, что почта отправлена именно с сервера указанного в поле <code>From</code>.</p> <h3 id="ustanovka-i-nastroika-opendkim"><a class="toclink" href="#ustanovka-i-nastroika-opendkim">Установка и настройка&nbsp;OpenDKIM</a></h3> <p>Устанавливаем необходимые пакеты, <a href="http://www.opendkim.org/">OpenDKIM</a>.</p> <div class="highlight"><pre><span></span>$ sudo apt-get install opendkim opendkim-tools
</pre></div> <p>Генерируем ключи и сохраняем их доступными для чтения группе <code>opendkim</code>, а также добавляем в эту группу <code>postfix</code>.</p> <div class="highlight"><pre><span></span>$ sudo mkdir /etc/opendkim
$ sudo opendkim-genkey -D /etc/opendkim -d <span class="k">$(</span>hostname -d<span class="k">)</span> -s <span class="k">$(</span>hostname<span class="k">)</span>
$ sudo chgrp opendkim /etc/opendkim/*
$ sudo chmod g+r /etc/opendkim/*
$ sudo gpasswd -a postfix opendkim
</pre></div> <p>Теперь указываем <code>opendkim</code> где находятся ключи. Для этого дописываем в конфигурационный файл <code>/etc/opendkim.conf</code> следующие&nbsp;строки.</p> <div class="highlight"><pre><span></span><span class="k">Canonicalization</span> <span class="k">relaxed</span><span class="n">/relaxed</span>
<span class="k">SyslogSuccess</span> <span class="k">yes</span>
<span class="k">RequireSafeKeys</span> <span class="k">false</span>
<span class="k">KeyTable</span> <span class="k">file</span><span class="err">:</span><span class="n">/etc/opendkim/keytable</span>
<span class="k">SigningTable</span> <span class="k">file</span><span class="err">:</span><span class="n">/etc/opendkim/signingtable</span>
<span class="k">X-Header</span> <span class="k">yes</span>
</pre></div> <p>Подробнее ознакомится с возможными параметрами можно в <a href="http://www.opendkim.org/opendkim.conf.5.html">документации</a>.</p> <p>Теперь заполним таблицы ключей в файлах <code>/etc/opendkim/keytable</code> и <code>/etc/opendkim/signingtable</code>. Они указывают соответсвие между доменом и ключем, которым необходимо подписывать&nbsp;письмо.</p> <div class="highlight"><pre><span></span><span class="c1"># /etc/opendkim/keytable</span>
ключ домен:селектор:/путь/до/ключа
</pre></div> <div class="highlight"><pre><span></span><span class="c1"># /etc/opendkim/signingtable</span>
домен ключ
</pre></div> <p>Например:</p> <div class="highlight"><pre><span></span><span class="c1"># /etc/opendkim/keytable</span>
mail._domainkey.example.com example.com:mail:/etc/opendkim/mail.private
</pre></div> <div class="highlight"><pre><span></span><span class="c1"># /etc/opendkim/signingtable</span>
example.com    mail._domainkey.example.com
</pre></div> <h3 id="nastroika-postfix-dlia-raboty-s-opendkim"><a class="toclink" href="#nastroika-postfix-dlia-raboty-s-opendkim">Настройка Postfix для работы с&nbsp;OpenDKIM</a></h3> <p>Указываем о необходимости подписывать все письма с помощью <code>dkim</code>.</p> <div class="highlight"><pre><span></span>$ sudo postconf -e <span class="nv">milter_default_action</span><span class="o">=</span>accept
$ sudo postconf -e <span class="nv">milter_protocol</span><span class="o">=</span><span class="m">2</span>
$ sudo postconf -e <span class="nv">smtpd_milters</span><span class="o">=</span>unix:/var/run/opendkim/opendkim.sock
$ sudo postconf -e <span class="nv">non_smtpd_milters</span><span class="o">=</span>unix:/var/run/opendkim/opendkim.sock
</pre></div> <p>Перезапускаем службы и отправляем подписанное&nbsp;письмо.</p> <div class="highlight"><pre><span></span>$ sudo service postfix restart
$ sudo service opendkim restart
</pre></div> <h2 id="nastroiiki-domennoi-zony"><a class="toclink" href="#nastroiiki-domennoi-zony">Настроийки доменной&nbsp;зоны</a></h2> <p>Чтобы сервер мог удостовериться в корректности подписи, нужно добавить <code>TXT</code> запись содежащую ключ. Сделать это нужно в контрольной панели регистратора. Проверим, что <code>dns</code> зоны&nbsp;обновились.</p> <div class="highlight"><pre><span></span>$ dig +short TXT mail._domainkey.example.com
<span class="s2">&quot;v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCvfTJ37Gqs06fhG0YYj/6HbojCrDp</span>
<span class="s2">F8X6u20YUaOax+jrvO0KtItfWYUi6hkCJeKbGTAOmqhWLu1T/DMt0XaICAJ7Q8525Z4ghwfvc5LgYyNSDEODeF</span>
<span class="s2">LNPlXgn3IP5o6Og2We/SnO4QCv8drKGf0N2xm5IIzIT8CjsbM6gPQIHTQIDAQAB&quot;</span>
</pre></div> <p>Также хорошо указать разрешенные <code>ip</code> адреса для исходящих писем в запись <code>spf</code>.</p> <div class="highlight"><pre><span></span>$ dig +short TXT example.com
<span class="s2">&quot;v=spf1 a:example.com ip4:&lt;ip v4 addr&gt; ip6:&lt;ip v6 addr&gt; ~all&quot;</span>
</pre></div> <h2 id="vse-ne-kak-u-liudei"><a class="toclink" href="#vse-ne-kak-u-liudei">Все не как у&nbsp;людей</a></h2> <p>Сегодня мы живем в далеком и почти светлом будущем, когда по бескрайним просторам сети широко распространяется <code>ipv6</code> адресация. Но, оказывается, абсолютно все письма отправленные с <code>ipv6</code> всегда воспринимаются гуглом как спам. Даже пройдя верификацию по <code>dkim</code> и <code>spf</code> записям, всеравно уходят в нежелательную&nbsp;почту.</p> <p>Так что укажем в конфигурации <code>postfix</code> отправку только с использованием <code>ipv4</code>.</p> <div class="highlight"><pre><span></span>$ sudo postconf -e <span class="nv">inet_protocols</span><span class="o">=</span>ipv4
</pre></div> <p>Теперь письма успешно доставляются и проходят все&nbsp;валидации.</p> <p><img alt="gmail ok" class="center shadow" src="/media/postfix/gmail_ok.png"></p> <p><details> <summary>Пример письма</summary></p> <div class="highlight"><pre><span></span><span class="n">Delivered</span><span class="o">-</span><span class="n">To</span><span class="p">:</span> <span class="n">samael500</span><span class="nd">@gmail.com</span>
<span class="n">Received</span><span class="p">:</span> <span class="n">by</span> <span class="mf">10.182</span><span class="o">.</span><span class="mf">174.67</span> <span class="k">with</span> <span class="n">SMTP</span> <span class="nb">id</span> <span class="n">bq3csp1452226obc</span><span class="p">;</span>
        <span class="n">Tue</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Feb</span> <span class="mi">2017</span> <span class="mi">08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">52</span> <span class="o">-</span><span class="mi">0800</span> <span class="p">(</span><span class="n">PST</span><span class="p">)</span>
<span class="n">X</span><span class="o">-</span><span class="n">Received</span><span class="p">:</span> <span class="n">by</span> <span class="mf">10.46</span><span class="o">.</span><span class="mf">22.18</span> <span class="k">with</span> <span class="n">SMTP</span> <span class="nb">id</span> <span class="n">w18mr1151641ljd</span><span class="o">.</span><span class="mf">86.1488298192253</span><span class="p">;</span>
        <span class="n">Tue</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Feb</span> <span class="mi">2017</span> <span class="mi">08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">52</span> <span class="o">-</span><span class="mi">0800</span> <span class="p">(</span><span class="n">PST</span><span class="p">)</span>
<span class="n">Return</span><span class="o">-</span><span class="n">Path</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">info</span><span class="err">@</span><span class="o">*********&gt;</span>
<span class="n">Received</span><span class="p">:</span> <span class="kn">from</span> <span class="o">*********</span> <span class="p">(</span><span class="o">*********.</span> <span class="p">[</span><span class="o">**.**.**.**</span><span class="p">])</span>
        <span class="n">by</span> <span class="n">mx</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="k">with</span> <span class="n">ESMTPS</span> <span class="nb">id</span> <span class="n">x14si1225569lfd</span><span class="o">.</span><span class="mf">155.2017</span><span class="o">.</span><span class="mf">02.28</span><span class="o">.</span><span class="mf">08.09</span><span class="o">.</span><span class="mi">51</span>
        <span class="k">for</span> <span class="o">&lt;</span><span class="n">samael500</span><span class="nd">@gmail.com</span><span class="o">&gt;</span>
        <span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">TLS1_2</span> <span class="n">cipher</span><span class="o">=</span><span class="n">ECDHE</span><span class="o">-</span><span class="n">RSA</span><span class="o">-</span><span class="n">AES128</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA256</span> <span class="n">bits</span><span class="o">=</span><span class="mi">128</span><span class="o">/</span><span class="mi">128</span><span class="p">);</span>
        <span class="n">Tue</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Feb</span> <span class="mi">2017</span> <span class="mi">08</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">52</span> <span class="o">-</span><span class="mi">0800</span> <span class="p">(</span><span class="n">PST</span><span class="p">)</span>
<span class="n">Received</span><span class="o">-</span><span class="n">SPF</span><span class="p">:</span> <span class="k">pass</span> <span class="p">(</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="n">domain</span> <span class="n">of</span> <span class="n">info</span><span class="err">@</span><span class="o">*********</span> <span class="n">designates</span> <span class="o">**.**.**.**</span> <span class="k">as</span> <span class="n">permitted</span> <span class="n">sender</span><span class="p">)</span> <span class="n">client</span><span class="o">-</span><span class="n">ip</span><span class="o">=**.**.**.**</span><span class="p">;</span>
<span class="n">Authentication</span><span class="o">-</span><span class="n">Results</span><span class="p">:</span> <span class="n">mx</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
       <span class="n">dkim</span><span class="o">=</span><span class="k">pass</span> <span class="n">header</span><span class="o">.</span><span class="n">i</span><span class="o">=*********</span><span class="p">;</span>
       <span class="n">spf</span><span class="o">=</span><span class="k">pass</span> <span class="p">(</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="n">domain</span> <span class="n">of</span> <span class="n">info</span><span class="err">@</span><span class="o">*********</span> <span class="n">designates</span> <span class="o">**.**.**.**</span> <span class="k">as</span> <span class="n">permitted</span> <span class="n">sender</span><span class="p">)</span> <span class="n">smtp</span><span class="o">.</span><span class="n">mailfrom</span><span class="o">=</span><span class="n">info</span><span class="err">@</span><span class="o">*********</span>
<span class="n">Received</span><span class="p">:</span> <span class="kn">from</span> <span class="o">*********</span> <span class="p">(</span><span class="n">localhost</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">])</span>
    <span class="n">by</span> <span class="o">*********</span> <span class="p">(</span><span class="n">Postfix</span><span class="p">)</span> <span class="k">with</span> <span class="n">ESMTP</span> <span class="nb">id</span> <span class="n">D9ED0452AB</span>
    <span class="k">for</span> <span class="o">&lt;</span><span class="n">samael500</span><span class="nd">@gmail.com</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Feb</span> <span class="mi">2017</span> <span class="mi">16</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">53</span> <span class="o">+</span><span class="mo">0000</span> <span class="p">(</span><span class="n">UTC</span><span class="p">)</span>
<span class="n">DKIM</span><span class="o">-</span><span class="n">Filter</span><span class="p">:</span> <span class="n">OpenDKIM</span> <span class="n">Filter</span> <span class="n">v2</span><span class="o">.</span><span class="mf">9.2</span> <span class="o">*********</span> <span class="n">D9ED0452AB</span>
<span class="n">DKIM</span><span class="o">-</span><span class="n">Signature</span><span class="p">:</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">a</span><span class="o">=</span><span class="n">rsa</span><span class="o">-</span><span class="n">sha256</span><span class="p">;</span> <span class="n">c</span><span class="o">=</span><span class="n">relaxed</span><span class="o">/</span><span class="n">relaxed</span><span class="p">;</span> <span class="n">d</span><span class="o">=*********</span><span class="p">;</span>
    <span class="n">s</span><span class="o">=</span><span class="n">mail</span><span class="p">;</span> <span class="n">t</span><span class="o">=</span><span class="mi">1488298193</span><span class="p">;</span>
    <span class="n">bh</span><span class="o">=</span><span class="n">juRoCRHzIAJJ4fKO8VlXEyxNddxTS8ftBnWmLxjdAik</span><span class="o">=</span><span class="p">;</span>
    <span class="n">h</span><span class="o">=</span><span class="n">Subject</span><span class="p">:</span><span class="n">From</span><span class="p">:</span><span class="n">To</span><span class="p">:</span><span class="n">Date</span><span class="p">:</span><span class="n">From</span><span class="p">;</span>
    <span class="n">b</span><span class="o">=</span><span class="n">G0Z6uXOV0LQHscdUOwMg5rjuJA</span><span class="o">/</span><span class="n">KWZ7x6Iqx3Z2x01nZ2kD</span><span class="o">+</span><span class="n">E1OgyP4zEfqS9XDiS</span>
     <span class="n">fG04P0qpIJyGEmO8hgRDIlH1d5FIDGjGPMAFDynwZ9j7pG1h88yLHThdtesUN7Fjib</span>
     <span class="mi">2</span><span class="n">yL1xxiyw2dZbtfvgXwhj0Nb9RXpphrY</span><span class="o">+</span><span class="n">c9v2fW4</span><span class="o">=</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">alternative</span><span class="p">;</span>
 <span class="n">boundary</span><span class="o">=</span><span class="s2">&quot;===============3211535685628593130==&quot;</span>
<span class="n">MIME</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Subject</span><span class="p">:</span> <span class="n">Hello</span> <span class="kn">from</span> <span class="nn">Earth</span>
<span class="n">From</span><span class="p">:</span> <span class="n">info</span><span class="err">@</span><span class="o">*********</span>
<span class="n">To</span><span class="p">:</span> <span class="n">samael500</span><span class="nd">@gmail.com</span>
<span class="n">Message</span><span class="o">-</span><span class="n">Id</span><span class="p">:</span> <span class="o">&lt;</span><span class="mf">20170228160953.</span><span class="n">D9ED0452AB</span><span class="o">*********&gt;</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">28</span> <span class="n">Feb</span> <span class="mi">2017</span> <span class="mi">16</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">53</span> <span class="o">+</span><span class="mo">0000</span> <span class="p">(</span><span class="n">UTC</span><span class="p">)</span>

<span class="o">--===============</span><span class="mi">3211535685628593130</span><span class="o">==</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;us-ascii&quot;</span>
<span class="n">MIME</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="mi">7</span><span class="n">bit</span>

<span class="n">There</span> <span class="n">are</span> <span class="n">test</span> <span class="n">mail</span> <span class="n">text</span> <span class="n">content</span>
<span class="o">--===============</span><span class="mi">3211535685628593130</span><span class="o">==</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;us-ascii&quot;</span>
<span class="n">MIME</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="mi">7</span><span class="n">bit</span>


<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Hello</span> <span class="kn">from</span> <span class="nn">Earth</span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">There</span> <span class="n">are</span> <span class="n">test</span> <span class="n">mail</span> <span class="n">html</span> <span class="n">content</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">p</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;color:red&quot;</span><span class="o">&gt;</span><span class="n">have</span> <span class="n">a</span> <span class="n">good</span> <span class="n">day</span> <span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>

<span class="o">--===============</span><span class="mi">3211535685628593130</span><span class="o">==--</span>
</pre></div> <p></details></p> <h2 id="django-settings"><a class="toclink" href="#django-settings">Django&nbsp;settings</a></h2> <p>Теперь можно подключить отправку писем через наш <code>smtp</code> в&nbsp;джанго.</p> <div class="highlight"><pre><span></span><span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">EMAIL_PORT</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">EMAIL_HOST_USER</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">EMAIL_HOST_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">EMAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">EMAIL_BACKEND</span> <span class="o">=</span> <span class="s1">&#39;django.core.mail.backends.smtp.EmailBackend&#39;</span>

<span class="n">DEFAULT_FROM_EMAIL</span> <span class="o">=</span> <span class="s1">&#39;info@example.com&#39;</span>
</pre></div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
                    var disqus_identifier = "articles/drugoe/sam-sebe-pochtalon/";
                    (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//samael500.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script> </div> </div> <div class="col-md-3 content-right"> <div class="anchorific"></div> </div> </div> </div> </div> </div> <div class="footer"> <div class="container"> <p>This blog is proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.</p> <p><a href="http://github.com/samael500/w3-personal-blog/">W3 Personal Blog</a> is a flat <a href="http://getbootstrap.com/">bootstrap</a> responsive theme designed by <a href="https://w3layouts.com/personal-blog-a-blogging-category-flat-bootstrap-responsive-web-template/">W3layouts</a> ported to a pelican by <a href="http://samael500.github.io/">Samael500</a>.<p> <p>Copyrights &copy; 2015&mdash;2017 Maks live All rights reserved.</p> <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p> </div> </div> <script type="text/javascript" src="https://www.l2.io/ip.js?var=userip"></script> <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter32194009 = new Ya.Metrika({
                    id:32194009,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true,
                    webvisor:true,
                    params:{'ip': userip}
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script> <noscript><div><img src="https://mc.yandex.ru/watch/32194009" style="position:absolute; left:-9999px;" alt></div></noscript> <script type="text/javascript">
    var disqus_shortname = 'samael500';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script> </body> </html>